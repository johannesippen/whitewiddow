<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no">
    <link rel="stylesheet" href="css/app.css">
    <link rel="stylesheet" href="css/bubbles.css">
    <link rel="stylesheet" href="css/permissions.css">
    <style>
      .debug {
        height: auto;
        min-height: 0;
        padding: 20px 0;
      }
      .debug a,
      .debug strong {
        display: block;
        background: #789;
        margin: 5px 14px;
        text-align: center;
        line-height: 33px;
        color: #fff;
      }
      .debug .done {
        font-weight: normal;
        color: #567;
        background: transparent;
      }
      #log {
        background: lightyellow;
        overflow: scroll;
        max-height: 150px;
        padding: 5px 20px;
      }
      a.fb {
        background: #3b5998;
      }
      .done:before {
        content: "\2714  ";
      }
      h1, h2, ul {
        margin-top: 0;
      }
    </style>
    <link rel="stylesheet" href="css/modes.css">
    <link rel="stylesheet" href="css/status.css">
  </head>
  <body class="ios" data-mode="" data-status="">
    <!-- Friend List -->
    <section id="friends">
      <div class="status_selector">
        <a id="status_free" class="selector">I&rsquo;m free</a>
      </div>
      <div class="friends">
        <ul id="friendlist" class="friendlist"></ul>
      </div>
      <div class="status_selector">
        <a id="status_busy" class="selector">I&rsquo;m busy</a>
      </div>
    </section>
    <!-- Pre Event Dashboard -->
    <section id="event">
      <div class="friends">
        <ul id="friendlist_event" class="friendlist secondary"></ul>
      </div>
      <img src="" class="map event_map" style="position: absolute; z-index: -1">
      <div class="attendees">
      </div>
      <div class="status_planned">
        <div class="invite_venue">
          <span class="invite_venue_name">%Venue%</span>
          <span class="invite_friend">%Name%</span>
          <span class="invite_set_time">%20:00%</span>
        </div>
      </div>
    </section>
    <!-- Invite Dialogue -->
    <section id="invite">
      <header>
        <button class="back">Back</button>
      </header>
      <div class="invite_dialogue">
        <div class="invite_map">
          <img src="" id="map" class="map">
        </div>
        <div class="invite_venue">
          <span class="invite_venue_name">%Venue%</span>
          <span class="invite_venue_distance">%0.0km%</span>
        </div>
        <div class="invite_confirm">
          <button>Send Invite</button>
        </div>
      </div>
    </section>
    <!-- Venue Details -->
    <section id="venue">
      <header>
        <button class="back">Back</button><h1>Details</h1>
      </header>
      <div class="venue_details">
        <div class="venue_image">
        </div>
        <div class="venue_venue">
          <span class="invite_venue_name">%Venue%</span>
          <span class="invite_venue_distance">%0.0km%</span>
        </div>
        <div class="venue_hours">
          <span class="venue_hours_title venue_title">Opening Hours</span>
          <span class="venue_hours_hours">Today open til 10pm</span>
        </div>
        <div class="venue_contact">
          <span class="venue_contact_title venue_title">Contact</span>
          <div class="venue_contact_actions">
            <a>Call</a>
            <a>Website</a>
          </div>
        </div>
      </div>
    </section>
    <section id="permissions">
      <section id="welcome" class="permission">
        <div class="permission_description">
          <p>Welcome to Whitewidow, where you meet real friends in real life.</p>
        </div>
        <div class="permission_action">
          <button>Facebook Connect</button>
        </div>
      </section>
      <section id="allowLocation" class="permission">
        <div class="permission_description">
          <p>Whitewidow finds the best places for you and your friends to meet.</p>
        </div>
        <div class="permission_action">
          <button>Allow Location</button>
        </div>
      </section>
      <section id="allowNotification" class="permission">
        <div class="permission_description">
          <p>We tell you when you're friends are available.</p>
        </div>
        <div class="permission_action">
          <button>Allow Notification</button>
        </div>
      </section>
      <section id="addFriends" class="permission">
        <div class="permission_description">
          <p>Now, add some Friends!</p>
        </div>
        <div class="permission_action">
          <button>Invite them</button>
        </div>
      </section>
    </section>
    <div style="padding-top: 568px;">
    <!-- Debug Menu -->
    <section id="debug" class="debug">
      <a onclick="window.location.reload();">&#8635; Reload</a>
      <a onclick="localStorage.removeItem('permissions');">Reset Onboarding</a>
      <a onclick="writeLog('Version: unknown')">Version</a>
      <a onclick="getInvitations()">Get Invitations</a>
      <a onclick="testCoreLocation()">Get Core Location</a>
      <p id="log">
        <!-- Generated Logs go here -->
      </p>
    </section>
    <!-- Onboarding -->
    <section id="onboarding" class="debug">
      <strong class="done" onclick="">1. Welcome</strong>
      <a class="fb" onclick="hasAccessToContacts();">2. Connect to Facebook</a>
      <a id="allowCoreLocation" class="" onclick="allowCoreLocation();">3. Allow Location</a>
      <a class="" onclick="">4. Allow Notifications</a>
      <a class="" onclick="inviteFBUser();">5. Invite Friends</a>
    </section>
    </div>

    <script src="js/zepto.min.js"></script>
    <script src="js/permissions.js"></script>
    <script src="js/friends.js"></script>
    <script src="js/interface.js"></script>
    <script src="js/modes.js"></script>
    <script src="js/status.js"></script>
    <script src="js/daytime.js"></script>
    <script src="js/location.js"></script>
    <script src="js/profile.js"></script>
    <script src="js/native/NativeConnector.js"></script>
    <script src="js/native/Social.js"></script>
    <script src="js/native/CoreLocation.js"></script>
    <script src="js/app.js"></script>
    <script>
      var connector = new NativeConnector();
      var social = new Social();
      var coreLocation = new CoreLocation();
      
      var activate_daytime = false;
      var friend_coordinates = [52.52585,13.341351];
      var my_coordinates = [52.490278,13.47];
      var map = document.getElementById('map');
      
      /* Write Log */
      var writeLog = function(msg) {
        document.getElementById("log").innerHTML += new Date().getTime()+" "+msg+"<br/>";
      };
      /* Facebook Connect */
      var hasAccessToContacts = function() {
        social.addNativeListener("connectFB", _onHasAccessReceived);
        social.connectFB();
        $('.fb').addClass('done');
      };
      var _onHasAccessReceived = function(data) {
        // TODO: not being fired
        log.innerHTML = "HasAccess: "+data.connectionState;
        writeLog("HasAccess: "+data.connectionState);
      };
      /* Get User Location */
      var allowCoreLocation = function() {
        coreLocation.addNativeListener("authorizeCoreLocation", _onCoreLocationAllowed);
        coreLocation.authorizeCoreLocation();
        $('#allowCoreLocation').addClass('done');
      };
      var testCoreLocation = function() {
        coreLocation.addNativeListener("getLocation", _onCoreLocationReceived);
        coreLocation.getLocation();
      };
      var _onCoreLocationAllowed = function(data) {
        writeLog('works!'); //TODO: Why doesn't this work?
      }
      var _onCoreLocationReceived = function(data) {
        log.innerHTML = JSON.stringify(data);
        writeLog(JSON.stringify(data));
        my_coordinates = [data.latitude,data.longitude];
        map.src = staticMapUrl(my_coordinates,friend_coordinates,320,320);
        getVenue(getMidpoint(my_coordinates,friend_coordinates),true);
      };
      /* Cet Contacts // Invite Friends */
      var inviteFBUser = function() {
        social.addNativeListener("getInvitedUser", _onContactsReceived);
        social.inviteFBUser("1031789260");
      };
      var _onContactsReceived = function(data) {
        log.innerHTML = data;
        writeLog(data);
      };
      
      var getInvitations = function() {
        social.addNativeListener("getConnectedFBContacts", _onContactsReceived);
        social.getInvitedUser();
      };

      $(function(){
        $('.invite_venue, .invite_venue_switch a').on('click',function(){
          $('.invite_venue_switch').toggleClass('active');
        });
        loadFriends(7);
        loadProfile();
      });
    </script>
  </body>
</html>